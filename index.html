<!DOCTYPE html>
<html>
<head>
  <title>Print Station</title>
</head>
<body>
  <h1>Print Station - Active</h1>
  <p>Status: <span id="status">Idle...</span></p>
  <script src="https://cdn.jsdelivr.net/npm/escpos-js@latest/dist/escpos.min.js"></script>
  <script>
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';
    const POLLING_INTERVAL = 10000; // 10 seconds

    const statusEl = document.getElementById('status');

    async function pollForJobs() {
      statusEl.textContent = 'Checking for new jobs...';
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/get-pending-jobs`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
        });
        const { job } = await response.json();

        if (job) {
          statusEl.textContent = `Printing job ${job.id}...`;
          await printReceipt(job); // Function to handle actual printing
          await updateJobStatus(job.id, 'completed');
          statusEl.textContent = `Job ${job.id} complete.`;
        } else {
          statusEl.textContent = 'Idle... No jobs found.';
        }
      } catch (error) {
        console.error('Polling error:', error);
        statusEl.textContent = `Error: ${error.message}`;
      }
    }

    async function printReceipt(job) {
        // 1. Generate the receipt text from 'job.receipt_data'
        // (This re-uses the logic from your 'create-receipt' function)
        const receiptText = `Order: ${job.order_id}\n------------------\nThank you!`; // Simplified example

        // 2. Connect to the printer via WebUSB
        try {
            const device = await escpos.USB.getDevice();
            const printer = await escpos.USB.open(device);

            // 3. Send commands to the printer
            await printer
                .init()
                .align('ct')
                .text(receiptText)
                .cut()
                .close();
             console.log('Successfully sent to printer.');
        } catch(error) {
            console.error('Printer connection failed:', error);
            // If printing fails, mark the job as 'failed'
            await updateJobStatus(job.id, 'failed');
            throw new Error('Failed to print.');
        }
    }

    async function updateJobStatus(jobId, status) {
        await fetch(`${SUPABASE_URL}/functions/v1/update-job-status`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ job_id: jobId, new_status: status })
        });
    }

    // Start polling when the page loads
    setInterval(pollForJobs, POLLING_INTERVAL);
    pollForJobs(); // Run once immediately
  </script>
</body>
</html>